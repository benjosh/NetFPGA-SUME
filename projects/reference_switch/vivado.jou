#-----------------------------------------------------------
# Vivado v2014.2 (64-bit)
# SW Build 932637 on Wed Jun 11 13:08:52 MDT 2014
# IP Build 924643 on Fri May 30 09:20:16 MDT 2014
# Start of session at: Wed Dec 10 13:49:33 2014
# Process ID: 7804
# Log file: /root/NetFPGA-SUME-2014.2/projects/reference_switch/vivado.log
# Journal file: /root/NetFPGA-SUME-2014.2/projects/reference_switch/vivado.jou
#-----------------------------------------------------------
start_gui
# Vivado Launch Script
#### Change design settings here #######
set design reference_switch 
set top top
#set sim_top board
set device xc7vx690t-2-ffg1761
set proj_dir ./synth
#set repo_dir ./ip_repo
#set repo_dir ../../../lib/ip_repo
set public_repo_dir /root/NetFPGA-SUME-2014.2/lib/ip_repo
set repo_dir ./ip_repo
set impl_constraints $::env(CONSTRAINTS)/vc709_generic.xdc
set bit_settings $::env(CONSTRAINTS)/vc709_generic_bit.xdc 
set project_constraints ./constraints/top.xdc
set ip_script ./ip_script.tcl
set nf_10g_constraints ./constraints/10g_interface.xdc
#####################################
# set IP paths
#####################################
set arbiter_ip $::env(IP_FOLDER)/input_arbiter/input_arbiter_v1_0_0.zip
# set arbiter_ip $::env(IP_FOLDER)/input_arbiter/component.xml
set output_port_lookup_ip $::env(IP_FOLDER)/output_port_lookup/output_port_lookup_v1_0_0.zip
set output_queues_ip $::env(IP_FOLDER)/output_queues/output_queues_v1_0_0.zip
set nf_10g_if_ip $::env(IP_FOLDER)/nf_10g_interface/nf_10g_interface_v1_0_0.zip
set pcie_2_axilite_ip $::env(XILINX_IP_FOLDER)/pcie2axilite_bridge/component.xml
# set axi_lite_ipif_ip $::env(XILINX_PATH)/data/ip/xilinx/axi_lite_ipif_v2_0/component.xml
#####################################
# Project Settings
#####################################
create_project -name ${design} -force -dir "./${proj_dir}" -part ${device}
set_property source_mgmt_mode DisplayOnly [current_project]
#set_property source_mgmt_mode All [current_project]  
set_property top ${top} [current_fileset]
puts "Creating User Datapath reference project"
#####################################
# Project Constraints
#####################################
create_fileset -constrset -quiet constraints
#file mkdir ${repo_dir}
file copy ${public_repo_dir}/ .
#source ${ip_script}
set_property ip_repo_paths ${repo_dir} [current_fileset]
add_files -fileset constraints -norecurse ${impl_constraints}
add_files -fileset constraints -norecurse ${bit_settings}
add_files -fileset constraints -norecurse ${project_constraints}
pwd
cd hw
close_project
# Vivado Launch Script
#### Change design settings here #######
set design reference_switch 
set top top
#set sim_top board
set device xc7vx690t-2-ffg1761
set proj_dir ./synth
#set repo_dir ./ip_repo
#set repo_dir ../../../lib/ip_repo
set public_repo_dir /root/NetFPGA-SUME-2014.2/lib/ip_repo
set repo_dir ./ip_repo
set impl_constraints $::env(CONSTRAINTS)/vc709_generic.xdc
set bit_settings $::env(CONSTRAINTS)/vc709_generic_bit.xdc 
set project_constraints ./constraints/top.xdc
set ip_script ./ip_script.tcl
set nf_10g_constraints ./constraints/10g_interface.xdc
#####################################
# set IP paths
#####################################
set arbiter_ip $::env(IP_FOLDER)/input_arbiter/input_arbiter_v1_0_0.zip
# set arbiter_ip $::env(IP_FOLDER)/input_arbiter/component.xml
set output_port_lookup_ip $::env(IP_FOLDER)/output_port_lookup/output_port_lookup_v1_0_0.zip
set output_queues_ip $::env(IP_FOLDER)/output_queues/output_queues_v1_0_0.zip
set nf_10g_if_ip $::env(IP_FOLDER)/nf_10g_interface/nf_10g_interface_v1_0_0.zip
set pcie_2_axilite_ip $::env(XILINX_IP_FOLDER)/pcie2axilite_bridge/component.xml
# set axi_lite_ipif_ip $::env(XILINX_PATH)/data/ip/xilinx/axi_lite_ipif_v2_0/component.xml
#####################################
# Project Settings
#####################################
create_project -name ${design} -force -dir "./${proj_dir}" -part ${device}
set_property source_mgmt_mode DisplayOnly [current_project]
#set_property source_mgmt_mode All [current_project]  
set_property top ${top} [current_fileset]
puts "Creating User Datapath reference project"
#####################################
# Project Constraints
#####################################
create_fileset -constrset -quiet constraints
#file mkdir ${repo_dir}
file copy ${public_repo_dir}/ .
#source ${ip_script}
set_property ip_repo_paths ${repo_dir} [current_fileset]
add_files -fileset constraints -norecurse ${impl_constraints}
add_files -fileset constraints -norecurse ${bit_settings}
add_files -fileset constraints -norecurse ${project_constraints}
add_files -fileset constraints -norecurse ${nf_10g_constraints}
set_property is_enabled false [get_files ${impl_constraints}]
set_property is_enabled true [get_files ${project_constraints}]
set_property is_enabled true [get_files ${bit_settings}]
set_property is_enabled true [get_files ${nf_10g_constraints}]
set_property constrset constraints [get_runs synth_1]
set_property constrset constraints [get_runs impl_1]
 
#####################################
# Project 
#####################################
update_ip_catalog
#update_ip_catalog -add_ip ${arbiter_ip} -repo_path ${repo_dir}
#update_ip_catalog -add_ip ${output_port_lookup_ip} -repo_path ${repo_dir}
#update_ip_catalog -add_ip ${output_queues_ip} -repo_path ${repo_dir}
#update_ip_catalog -add_ip ${nf_10g_if_ip} -repo_path ${repo_dir}
source ./create_ip/output_port_lookup.tcl
create_ip -name output_port_lookup -vendor NetFPGA -library NetFPGA -module_name output_port_lookup_ip
set_property generate_synth_checkpoint false [get_files output_port_lookup_ip.xci]
reset_target all [get_ips output_port_lookup_ip]
generate_target all [get_ips output_port_lookup_ip]
source ./create_ip/input_arbiter.tcl
create_ip -name input_arbiter -vendor NetFPGA -library NetFPGA -module_name input_arbiter_ip
set_property generate_synth_checkpoint false [get_files input_arbiter_ip.xci]
reset_target all [get_ips input_arbiter_ip]
generate_target all [get_ips input_arbiter_ip]
source ./create_ip/output_queues.tcl
create_ip -name output_queues -vendor NetFPGA -library NetFPGA -module_name output_queues_ip
set_property generate_synth_checkpoint false [get_files output_queues_ip.xci]
reset_target all [get_ips output_queues_ip]
generate_target all [get_ips output_queues_ip]
#create the IPI Block Diagram
create_bd_design "pcie2axilite_sub"
open_bd_design "pcie2axilite_sub"
update_ip_catalog -add_ip ${pcie_2_axilite_ip} -repo_path ${repo_dir}
source ./source/pcie2axilite_sub_256.tcl
validate_bd_design
save_bd_design
source ./create_ip/nf10_axis_converter.tcl
source ./create_ip/nf_10g_interface.tcl
create_ip -name nf_10g_interface -vendor NetFPGA -library NetFPGA -module_name nf10_10g_interface
set_property generate_synth_checkpoint false [get_files nf10_10g_interface.xci]
reset_target all [get_ips nf_10g_interface]
generate_target all [get_ips nf_10g_interface]
read_verilog "./source/nf10_datapath.v"
read_verilog "./source/top.v"
#Setting Synthesis options
create_run -flow {Vivado Synthesis 2013} synth
#Setting Implementation options
create_run impl -parent_run synth -flow {Vivado Implementation 2013} 
set_property steps.phys_opt_design.is_enabled true [get_runs impl]
# The following implementation options will increase runtime, but get the best timing results
set_property strategy Performance_Explore [get_runs impl]
# Solves synthesis crash in 2013.2
set_param synth.filterSetMaxDelayWithDataPathOnly true
set_property SEVERITY {Warning} [get_drc_checks UCIO-1]
set_property top top [get_filesets sim_1]
generate_target Simulation [get_files /root/NetFPGA-SUME-2014.2/projects/reference_switch/hw/synth/reference_switch.srcs/sources_1/ip/nf10_axis_converter_master/nf10_axis_converter_master.xci]
generate_target Simulation [get_files /root/NetFPGA-SUME-2014.2/projects/reference_switch/hw/synth/reference_switch.srcs/sources_1/ip/nf10_axis_converter_slave/nf10_axis_converter_slave.xci]
generate_target Simulation [get_files /root/NetFPGA-SUME-2014.2/projects/reference_switch/hw/synth/reference_switch.srcs/sources_1/ip/nf10_10g_interface/nf10_10g_interface.xci]
launch_xsim -simset sim_1 -mode behavioral
